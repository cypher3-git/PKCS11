# PKCS#11 TA é¡¹ç›®æ–‡ä»¶åŠŸèƒ½æ¦‚è¿°ä¸ä»£ç é˜…è¯»æŒ‡å—

## ğŸ“š é¡¹ç›®ç»“æ„æ¦‚è§ˆ

è¿™æ˜¯ä¸€ä¸ªåŸºäº OP-TEE çš„ PKCS#11 Trusted Applicationï¼Œå®ç°äº†åŠ å¯†ä»¤ç‰Œçš„æ ¸å¿ƒåŠŸèƒ½ã€‚

```
pkcs11/
â”œâ”€â”€ æ„å»ºæ–‡ä»¶
â”‚   â”œâ”€â”€ Makefile          # ä¸»æ„å»ºæ–‡ä»¶ï¼Œå®šä¹‰ TA UUID
â”‚   â”œâ”€â”€ sub.mk            # æ„å»ºé…ç½®å’Œç¼–è¯‘é€‰é¡¹
â”‚   â”œâ”€â”€ user_ta.mk        # TA ç”¨æˆ·æ€é…ç½®
â”‚   â””â”€â”€ Android.mk        # Android å¹³å°æ„å»º
â”‚
â”œâ”€â”€ include/              # å…¬å…±å¤´æ–‡ä»¶
â”‚   â””â”€â”€ pkcs11_ta.h       # PKCS#11 TA æ¥å£å®šä¹‰
â”‚
â””â”€â”€ src/                  # æºä»£ç ç›®å½•
    â”œâ”€â”€ æ ¸å¿ƒæ¡†æ¶å±‚
    â”œâ”€â”€ å¯¹è±¡ç®¡ç†å±‚
    â”œâ”€â”€ å¯†ç å¤„ç†å±‚
    â””â”€â”€ å·¥å…·æ”¯æŒå±‚
```

---

## ä¸€ã€æºæ–‡ä»¶åˆ†ç±»ä¸åŠŸèƒ½è¯´æ˜

### ğŸ”· 1. æ ¸å¿ƒæ¡†æ¶å±‚ï¼ˆTA ç”Ÿå‘½å‘¨æœŸä¸å…¥å£ï¼‰

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|----------|
| `entry.c` | **TA ä¸»å…¥å£ç‚¹**<br>â€¢ å¤„ç†æ‰€æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„ PKCS#11 å‘½ä»¤<br>â€¢ å‘½ä»¤åˆ†å‘ä¸å‚æ•°è§£æ<br>â€¢ é”™è¯¯ç è½¬æ¢ |
| `user_ta_header_defines.h` | **TA å…ƒæ•°æ®å®šä¹‰**<br>â€¢ TA UUID<br>â€¢ TA æè¿°ä¿¡æ¯ |

### ğŸ”· 2. ä»¤ç‰Œç®¡ç†å±‚

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|----------|
| `pkcs11_token.h/.c` | **ä»¤ç‰Œæ ¸å¿ƒç®¡ç†**<br>â€¢ ä»¤ç‰Œåˆå§‹åŒ–ä¸é”€æ¯<br>â€¢ ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»ºã€ç™»å½•ã€ç™»å‡ºï¼‰<br>â€¢ ä»¤ç‰ŒçŠ¶æ€ç»´æŠ¤ |
| `token_capabilities.h/.c` | **ä»¤ç‰Œèƒ½åŠ›å£°æ˜**<br>â€¢ æ”¯æŒçš„æœºåˆ¶åˆ—è¡¨<br>â€¢ æœºåˆ¶çš„æ ‡å¿—ä½å’Œå‚æ•°<br>â€¢ èƒ½åŠ›æŸ¥è¯¢æ¥å£ |
| `persistent_token.c` | **ä»¤ç‰ŒæŒä¹…åŒ–å­˜å‚¨**<br>â€¢ åŸºäº TEE å®‰å…¨å­˜å‚¨<br>â€¢ PIN å“ˆå¸Œå­˜å‚¨<br>â€¢ å¯¹è±¡ UUID æ•°æ®åº“ç®¡ç† |

### ğŸ”· 3. å¯¹è±¡ç®¡ç†å±‚

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|----------|
| `object.h/.c` | **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†**<br>â€¢ å¯¹è±¡åˆ›å»ºã€é”€æ¯ã€æŸ¥æ‰¾<br>â€¢ å¯¹è±¡åˆ—è¡¨ç»´æŠ¤<br>â€¢ ä¼šè¯å¯¹è±¡ vs ä»¤ç‰Œå¯¹è±¡ |
| `handle.h/.c` | **å¥æŸ„ç®¡ç†**<br>â€¢ å¯¹è±¡å¥æŸ„åˆ†é…ä¸å›æ”¶<br>â€¢ å¥æŸ„åˆ°å¯¹è±¡çš„æ˜ å°„<br>â€¢ ä¼šè¯å¥æŸ„ç®¡ç† |
| `attributes.h/.c` | **å±æ€§åº•å±‚æ“ä½œ**<br>â€¢ å±æ€§åºåˆ—åŒ–/ååºåˆ—åŒ–<br>â€¢ å±æ€§è¯»å†™æ¥å£<br>â€¢ å†…å­˜ç®¡ç† |
| `pkcs11_attributes.h/.c` | **PKCS#11 å±æ€§è¯­ä¹‰**<br>â€¢ å±æ€§åˆè§„æ€§æ£€æŸ¥<br>â€¢ é»˜è®¤å€¼å¡«å……<br>â€¢ å±æ€§ç»§æ‰¿è§„åˆ™ |
| `sanitize_object.h/.c` | **å¯¹è±¡æ¸…ç†ä¸éªŒè¯**<br>â€¢ å®¢æˆ·ç«¯æ¨¡æ¿éªŒè¯<br>â€¢ ç±»åˆ«ä¸ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥ |

### ğŸ”· 4. å¯†ç å¤„ç†å±‚

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|----------|
| `processing.h/.c` | **å¤„ç†å¼•æ“æ ¸å¿ƒ**<br>â€¢ å¯†ç æ“ä½œè°ƒåº¦<br>â€¢ Initâ†’Updateâ†’Final çŠ¶æ€æœº<br>â€¢ å¯†é’¥ç”Ÿæˆ/æ´¾ç”Ÿ/åŒ…è£… |
| `processing_symm.c` | **å¯¹ç§°åŠ å¯†å¤„ç†**<br>â€¢ AES/DES åŠ è§£å¯†<br>â€¢ HMAC ç­¾åéªŒç­¾<br>â€¢ å¯†é’¥æ´¾ç”Ÿ |
| `processing_aes.c` | **AES ç‰¹å®šå¤„ç†**<br>â€¢ GCM/CCM è®¤è¯åŠ å¯†<br>â€¢ CTR æ¨¡å¼<br>â€¢ å¯†é’¥åŒ…è£… |
| `processing_asymm.c` | **éå¯¹ç§°åŠ å¯†å¤„ç†**<br>â€¢ RSA/EC/EdDSA ç­¾åéªŒç­¾<br>â€¢ åŠ è§£å¯†<br>â€¢ å¯†é’¥å¯¹ç”Ÿæˆ |
| `processing_rsa.c` | **RSA ç‰¹å®šå¤„ç†**<br>â€¢ PSS/OAEP å‚æ•°å¤„ç†<br>â€¢ RSA-AES æ··åˆåŒ…è£… |
| `processing_ec.c` | **æ¤­åœ†æ›²çº¿å¤„ç†**<br>â€¢ ECDSA ç­¾å<br>â€¢ ECDH å¯†é’¥åå•†<br>â€¢ EdDSA |
| `processing_digest.c` | **æ‘˜è¦å¤„ç†**<br>â€¢ MD5/SHA-1/SHA-2<br>â€¢ C_DigestKey æ”¯æŒ |

### ğŸ”· 5. å·¥å…·æ”¯æŒå±‚

| æ–‡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|------|----------|
| `serializer.h/.c` | **åºåˆ—åŒ–å·¥å…·**<br>â€¢ å‚æ•°æ‰“åŒ…/è§£åŒ…<br>â€¢ å­—èŠ‚æµå¤„ç† |
| `pkcs11_helpers.h/.c` | **é€šç”¨è¾…åŠ©å‡½æ•°**<br>â€¢ ID è½¬å­—ç¬¦ä¸²ï¼ˆè°ƒè¯•ï¼‰<br>â€¢ PKCSâ†”TEE ç±»å‹è½¬æ¢<br>â€¢ é”™è¯¯ç æ˜ å°„ |

---

## äºŒã€ğŸ¯ æ¨èä»£ç é˜…è¯»é¡ºåº

### é˜¶æ®µ 1ï¼šç†è§£æ¶æ„å’Œæ¥å£ â­â­â­

```
1. include/pkcs11_ta.h          # PKCS#11 å‘½ä»¤å’Œæ•°æ®ç»“æ„å®šä¹‰
2. src/user_ta_header_defines.h # TA åŸºæœ¬ä¿¡æ¯
3. src/entry.c                  # å‘½ä»¤å…¥å£ï¼Œäº†è§£æ•´ä½“æµç¨‹
4. src/pkcs11_helpers.h         # è¾…åŠ©å‡½æ•°æ¥å£
```

**ç›®æ ‡**ï¼šæŒæ¡ TA å¦‚ä½•æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚

---

### é˜¶æ®µ 2ï¼šä»¤ç‰Œå’Œä¼šè¯ç®¡ç† â­â­â­

```
5. src/pkcs11_token.h           # ä»¤ç‰Œå’Œä¼šè¯æ•°æ®ç»“æ„
6. src/pkcs11_token.c           # ä»¤ç‰Œåˆå§‹åŒ–ã€ç™»å½•ã€ä¼šè¯ç®¡ç†
7. src/token_capabilities.h/.c  # æ”¯æŒçš„æœºåˆ¶å’Œèƒ½åŠ›
8. src/persistent_token.c       # æŒä¹…åŒ–å­˜å‚¨ï¼ˆPINã€å¯¹è±¡ï¼‰
```

**ç›®æ ‡**ï¼šç†è§£ä»¤ç‰ŒçŠ¶æ€æœºå’Œä¼šè¯ç”Ÿå‘½å‘¨æœŸ

---

### é˜¶æ®µ 3ï¼šå¯¹è±¡ç®¡ç†ç³»ç»Ÿ â­â­â­â­

```
9.  src/serializer.h/.c         # åºåˆ—åŒ–åŸºç¡€
10. src/attributes.h/.c         # å±æ€§åº•å±‚æ“ä½œ
11. src/sanitize_object.h/.c    # å¯¹è±¡éªŒè¯
12. src/pkcs11_attributes.h/.c  # å±æ€§è¯­ä¹‰å’Œè§„åˆ™æ£€æŸ¥
13. src/handle.h/.c             # å¥æŸ„ç®¡ç†
14. src/object.h/.c             # å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼ˆé‡ç‚¹ï¼ï¼‰
```

**ç›®æ ‡**ï¼šæŒæ¡å¯¹è±¡å¦‚ä½•åˆ›å»ºã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œé”€æ¯

---

### é˜¶æ®µ 4ï¼šå¯†ç æ“ä½œå¼•æ“ â­â­â­â­â­

```
15. src/processing.h            # å¤„ç†æ¡†æ¶æ¥å£å®šä¹‰
16. src/processing.c            # å¤„ç†è°ƒåº¦æ ¸å¿ƒï¼ˆé‡ç‚¹ï¼ï¼‰
17. src/processing_digest.c     # æ‘˜è¦æ“ä½œï¼ˆæœ€ç®€å•ï¼Œå…ˆçœ‹ï¼‰
18. src/processing_symm.c       # å¯¹ç§°åŠ å¯†
19. src/processing_aes.c        # AES ç‰¹å®šå¤„ç†
20. src/processing_asymm.c      # éå¯¹ç§°åŠ å¯†æ¡†æ¶
21. src/processing_rsa.c        # RSA ç‰¹å®šå¤„ç†
22. src/processing_ec.c         # æ¤­åœ†æ›²çº¿å¤„ç†
```

**ç›®æ ‡**ï¼šç†è§£ Initâ†’Updateâ†’Final çŠ¶æ€æœºå’Œå„ç§å¯†ç ç®—æ³•å®ç°

---

### é˜¶æ®µ 5ï¼šè¾…åŠ©å·¥å…· â­

```
23. src/pkcs11_helpers.c        # ç±»å‹è½¬æ¢ã€è°ƒè¯•å·¥å…·
```

**ç›®æ ‡**ï¼šäº†è§£è°ƒè¯•å’Œå·¥å…·å‡½æ•°

---

## ä¸‰ã€ğŸ”‘ å…³é”®æ¦‚å¿µå’Œæ•°æ®æµ

### 1. å…¸å‹å‘½ä»¤å¤„ç†æµç¨‹

```
å®¢æˆ·ç«¯è°ƒç”¨ C_Encrypt()
    â†“
entry.c::TA_InvokeCommandEntryPoint()
    â†“
entry.c::entry_ck_encrypt_init() 
    â†“
processing.c::entry_processing_init()
    â†“
processing_symm.c::init_symm_operation()
    â†“
TEE Crypto API
```

### 2. å¯¹è±¡åˆ›å»ºæµç¨‹

```
C_CreateObject()
    â†“
sanitize_object.c::sanitize_client_object()  # éªŒè¯æ¨¡æ¿
    â†“
pkcs11_attributes.c::create_attributes_from_template()  # åˆ›å»ºå±æ€§
    â†“
object.c::create_object()  # åˆ›å»ºå¯¹è±¡å®ä¾‹
    â†“
handle.c::handle_get()  # åˆ†é…å¥æŸ„
```

### 3. æ ¸å¿ƒæ•°æ®ç»“æ„å…³ç³»

```
struct ck_token                 # ä»¤ç‰Œå®ä¾‹
    â”œâ”€â”€ struct pkcs11_session   # ä¼šè¯åˆ—è¡¨
    â”‚       â””â”€â”€ struct active_processing  # å½“å‰æ“ä½œ
    â””â”€â”€ struct pkcs11_object    # å¯¹è±¡åˆ—è¡¨
            â””â”€â”€ struct obj_attrs  # å¯¹è±¡å±æ€§
```

---

## å››ã€ğŸ’¡ å­¦ä¹ å»ºè®®

### 1. å…ˆçœ‹å®è§‚ï¼Œå†çœ‹ç»†èŠ‚
- ä» `entry.c` å¼€å§‹ï¼Œç†è§£å‘½ä»¤å¦‚ä½•åˆ†å‘
- å†æ·±å…¥å„ä¸ªå­ç³»ç»Ÿ

### 2. å…³æ³¨çŠ¶æ€æœº
- **ä»¤ç‰ŒçŠ¶æ€**ï¼šæœªåˆå§‹åŒ–â†’å·²åˆå§‹åŒ–â†’å·²ç™»å½•
- **ä¼šè¯çŠ¶æ€**ï¼šåªè¯»/è¯»å†™ã€å…¬å¼€/ç§æœ‰
- **å¤„ç†çŠ¶æ€**ï¼šInitâ†’Updateâ†’Final

### 3. é‡ç‚¹æ–‡ä»¶æ ‡è®°
- â­â­â­â­â­ï¼š`processing.c`, `object.c` - æœ€æ ¸å¿ƒ
- â­â­â­â­ï¼š`pkcs11_attributes.c`, `pkcs11_token.c` - é‡è¦é€»è¾‘
- â­â­â­ï¼šå…¶ä»–æ¡†æ¶æ–‡ä»¶
- â­ï¼šè¾…åŠ©å·¥å…·

### 4. è°ƒè¯•æŠ€å·§
- å¯ç”¨ `CFG_TEE_TA_LOG_LEVEL=4` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- å…³æ³¨ `id2str_*` å‡½æ•°è¾“å‡ºçš„è°ƒè¯•ä¿¡æ¯
- ä½¿ç”¨ `trace_attributes_*` æŸ¥çœ‹å±æ€§å†…å®¹

### 5. PKCS#11 è§„èŒƒå¯¹ç…§
- å»ºè®®åŒæ—¶é˜…è¯» PKCS#11 v2.40 è§„èŒƒ
- ä»£ç ä¸­çš„æ£€æŸ¥é€»è¾‘éƒ½å¯¹åº”è§„èŒƒè¦æ±‚

---

## äº”ã€å¿«é€Ÿå‚è€ƒï¼šæ–‡ä»¶å®Œæ•´åˆ—è¡¨

### æ„å»ºæ–‡ä»¶
- `Makefile` - ä¸»æ„å»ºæ–‡ä»¶
- `sub.mk` - æ„å»ºé…ç½®
- `user_ta.mk` - TA é…ç½®
- `Android.mk` - Android æ„å»º

### å¤´æ–‡ä»¶
- `include/pkcs11_ta.h` - å…¬å…±æ¥å£
- `src/user_ta_header_defines.h` - TA å…ƒæ•°æ®
- `src/attributes.h` - å±æ€§æ“ä½œ
- `src/handle.h` - å¥æŸ„ç®¡ç†
- `src/object.h` - å¯¹è±¡ç®¡ç†
- `src/pkcs11_attributes.h` - å±æ€§è¯­ä¹‰
- `src/pkcs11_helpers.h` - è¾…åŠ©å‡½æ•°
- `src/pkcs11_token.h` - ä»¤ç‰Œç®¡ç†
- `src/processing.h` - å¤„ç†æ¡†æ¶
- `src/sanitize_object.h` - å¯¹è±¡éªŒè¯
- `src/serializer.h` - åºåˆ—åŒ–
- `src/token_capabilities.h` - ä»¤ç‰Œèƒ½åŠ›

### æºæ–‡ä»¶
- `src/entry.c` - TA å…¥å£
- `src/attributes.c` - å±æ€§å®ç°
- `src/handle.c` - å¥æŸ„å®ç°
- `src/object.c` - å¯¹è±¡ç®¡ç†
- `src/persistent_token.c` - æŒä¹…åŒ–
- `src/pkcs11_attributes.c` - å±æ€§è¯­ä¹‰
- `src/pkcs11_helpers.c` - è¾…åŠ©å‡½æ•°
- `src/pkcs11_token.c` - ä»¤ç‰Œç®¡ç†
- `src/processing.c` - å¤„ç†æ ¸å¿ƒ
- `src/processing_aes.c` - AES å¤„ç†
- `src/processing_asymm.c` - éå¯¹ç§°å¤„ç†
- `src/processing_digest.c` - æ‘˜è¦å¤„ç†
- `src/processing_ec.c` - æ¤­åœ†æ›²çº¿
- `src/processing_rsa.c` - RSA å¤„ç†
- `src/processing_symm.c` - å¯¹ç§°åŠ å¯†
- `src/sanitize_object.c` - å¯¹è±¡éªŒè¯
- `src/serializer.c` - åºåˆ—åŒ–
- `src/token_capabilities.c` - ä»¤ç‰Œèƒ½åŠ›

---

**ç¥å­¦ä¹ é¡ºåˆ©ï¼å¦‚æœ‰å…·ä½“ä»£ç é—®é¢˜ï¼Œéšæ—¶æé—®ã€‚**

